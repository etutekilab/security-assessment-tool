<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark light">
    
    <!-- Load environment first -->
    <script>
        // Add a global error handler for script loading
        window.handleScriptError = function(scriptSrc) {
            console.error(`Failed to load script: ${scriptSrc}`);
            const banner = document.createElement('div');
            banner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #ff4444;
                color: white;
                padding: 10px;
                text-align: center;
                z-index: 9999;
            `;
            banner.textContent = `⚠️ Failed to load required script: ${scriptSrc}`;
            document.body.appendChild(banner);
        };
    </script>
    
    <script src="env.js" onerror="handleScriptError('env.js')"></script>
    
    <!-- Load dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Initialize app -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Debug environment loading
                console.log('Environment check:', {
                    exists: !!window.env,
                    hasOpenAI: !!window.env?.OPENAI_API_KEY,
                    hasSupabase: !!window.env?.SUPABASE_URL && !!window.env?.SUPABASE_ANON_KEY
                });

                // Validate environment configuration
                if (!window.env) {
                    throw new Error('Environment configuration not loaded. Please refresh the page.');
                }

                // Validate API credentials
                const missingCredentials = [];
                if (!window.env.OPENAI_API_KEY) missingCredentials.push('OpenAI API Key');
                if (!window.env.SUPABASE_URL) missingCredentials.push('Supabase URL');
                if (!window.env.SUPABASE_ANON_KEY) missingCredentials.push('Supabase Anon Key');

                if (missingCredentials.length > 0) {
                    throw new Error(`Missing required credentials: ${missingCredentials.join(', ')}`);
                }

                // Initialize Supabase
                window.supabase = createClient(
                    window.env.SUPABASE_URL,
                    window.env.SUPABASE_ANON_KEY
                );

                // Test API connections
                const { data, error } = await window.supabase.from('assessments').select('count(*)').limit(1);
                if (error) throw error;

                // Enable API features
                document.querySelectorAll('.ai-notes-btn').forEach(btn => {
                    btn.disabled = false;
                    btn.title = 'Get AI suggestions';
                });
                
                document.querySelector('.submit-btn')?.removeAttribute('disabled');
            } catch (error) {
                console.error('API Initialization error:', error);
                const banner = document.createElement('div');
                banner.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #ff4444;
                    color: white;
                    padding: 10px;
                    text-align: center;
                    z-index: 9999;
                `;
                banner.textContent = `⚠️ ${error.message}`;
                document.body.appendChild(banner);
            }
        });
    </script>
    
    <!-- Load application scripts -->
    <script src="script.js"></script>
    
    <title>Cybersecurity Assessment</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header>
        <nav>
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <a href="https://www.etutekilab.com" target="_blank" rel="noopener">Etuteki_Lab</a>
            </div>
        </nav>
    </header>

    <main>
        <div class="container">
            <h1></h1>
            <p class="intro"></p>
            
            <div id="assessment-form">
                <!-- Progress bar and sections will be dynamically loaded here -->
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <p>&copy; 2025 All rights reserved.</p>
            <p class="powered-by">
                Powered by <a href="https://www.etutekilab.com" target="_blank" rel="noopener">Etuteki Lab</a>
            </p>
        </div>
    </footer>
</body>
</html> 